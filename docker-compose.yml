services:
  base:
    platform: linux/arm64
    build:
      context: .
      dockerfile: Dockerfile.base
    image: logicourt-base:latest
    command: echo "Base image built!"

  core:
    platform: linux/arm64
    build:
      context: ./core
      dockerfile: Dockerfile
    depends_on:
      - base
    volumes:
      - ./core:/app  # 개발용 코드 마운트
      - data:/data  # 공유 데이터
      - /tmp/.X11-unix:/tmp/.X11-unix  # X11 소켓 (PyQt5 GUI용)
    environment:
      - DISPLAY=${DISPLAY:-:0}  # X11 디스플레이
      - QT_X11_NO_MITSHM=1  # Qt X11 공유 메모리 비활성화
    env_file:
      - .env
    command: python main.py  # PyQt5 GUI 실행
    ports:
      - "8000:8000"  # FastAPI 서버 (백엔드 API)
    networks:
      - logicourt_network
    privileged: true  # 하드웨어 접근용
    restart: unless-stopped

  hardware:
    platform: linux/arm64  # arm6 → arm64 수정
    build:
      context: ./hardware
      dockerfile: Dockerfile
    depends_on:
      - base
    volumes:
      - ./hardware:/app
      - data:/data
    env_file:
      - .env
    command: uvicorn main:app --host 0.0.0.0 --port 8300
    ports:
      - "8300:8300"
    networks:
      - logicourt_network
    privileged: true  # GPIO 접근용
    restart: unless-stopped

volumes:
  data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data  # 로컬 디렉토리를 마운트

# # 메모리 제한 설정 - 라즈베리파이5 기준 
# deploy:
#   resources:
#     limits:
#       cpus: "4" # 4개의 코어 사용
#       memory: "8g" # 8GB의 메모리 사용  

networks:
  logicourt_network:
    driver: bridge